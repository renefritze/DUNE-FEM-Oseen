<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN""http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<title>dune-istl: pardiso.hh Source File (dune-istl )</title>
  <link rel="stylesheet" type="text/css" href="./dune-doxy.css">
  <link rel="stylesheet" type="text/css" href="./tabs.css">
</head>
<div class="main">
<div class="doxygen">
<!-- Generated by Doxygen 1.5.6 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="classes.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div class="navpath"><a class="el" href="dir_39c25fa0261c9359275e2f8975608afb.html">istl</a>
  </div>
</div>
<div class="contents">
<h1>pardiso.hh</h1><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="preprocessor">#ifndef DUNE_PARDISO_HH</span>
<a name="l00002"></a>00002 <span class="preprocessor"></span><span class="preprocessor">#define DUNE_PARDISO_HH</span>
<a name="l00003"></a>00003 <span class="preprocessor"></span>
<a name="l00004"></a>00004 <span class="preprocessor">#include &lt;dune/istl/preconditioners.hh&gt;</span>
<a name="l00005"></a>00005 
<a name="l00006"></a>00006 <span class="comment">/* Change this, if your Fortran compiler does not append underscores. */</span>
<a name="l00007"></a>00007 <span class="comment">/* e.g. the AIX compiler:  #define F77_FUNC(func) func                */</span>
<a name="l00008"></a>00008 
<a name="l00009"></a>00009 <span class="preprocessor">#ifdef AIX</span>
<a name="l00010"></a>00010 <span class="preprocessor"></span><span class="preprocessor">#define F77_FUNC(func)  func </span>
<a name="l00011"></a>00011 <span class="preprocessor"></span><span class="preprocessor">#else</span>
<a name="l00012"></a>00012 <span class="preprocessor"></span><span class="preprocessor">#define F77_FUNC(func)  func ## _</span>
<a name="l00013"></a>00013 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00014"></a>00014 <span class="preprocessor"></span>
<a name="l00015"></a>00015 
<a name="l00016"></a>00016 <span class="preprocessor">#ifdef HAVE_PARDISO </span>
<a name="l00017"></a>00017 <span class="preprocessor"></span><span class="comment">/* PARDISO prototype. */</span>
<a name="l00018"></a>00018 <span class="keyword">extern</span> <span class="stringliteral">"C"</span> <span class="keywordtype">int</span> F77_FUNC(pardisoinit)
<a name="l00019"></a>00019     (<span class="keywordtype">void</span> *, <span class="keywordtype">int</span> *, <span class="keywordtype">int</span> *);
<a name="l00020"></a>00020 
<a name="l00021"></a>00021 <span class="keyword">extern</span> <span class="stringliteral">"C"</span> <span class="keywordtype">int</span> F77_FUNC(pardiso)
<a name="l00022"></a>00022     (<span class="keywordtype">void</span> *, <span class="keywordtype">int</span> *, <span class="keywordtype">int</span> *, <span class="keywordtype">int</span> *, <span class="keywordtype">int</span> *, <span class="keywordtype">int</span> *, 
<a name="l00023"></a>00023      <span class="keywordtype">double</span> *, <span class="keywordtype">int</span> *, <span class="keywordtype">int</span> *, <span class="keywordtype">int</span> *, <span class="keywordtype">int</span> *, <span class="keywordtype">int</span> *, 
<a name="l00024"></a>00024      <span class="keywordtype">int</span> *, <span class="keywordtype">double</span> *, <span class="keywordtype">double</span> *, <span class="keywordtype">int</span> *);
<a name="l00025"></a>00025 <span class="preprocessor">#endif </span>
<a name="l00026"></a>00026 <span class="preprocessor"></span>
<a name="l00027"></a>00027 <span class="keyword">namespace </span>Dune {
<a name="l00028"></a>00028 
<a name="l00029"></a>00029 
<a name="l00034"></a>00034   <span class="keyword">template</span>&lt;<span class="keyword">class</span> M, <span class="keyword">class</span> X, <span class="keyword">class</span> Y&gt;
<a name="l00035"></a><a class="code" href="a00107.html">00035</a>   <span class="keyword">class </span><a class="code" href="a00107.html" title="The sequential Pardiso preconditioner.">SeqPardiso</a> : <span class="keyword">public</span> <a class="code" href="a00092.html" title="Base class for matrix free definition of preconditioners.">Preconditioner</a>&lt;X,Y&gt; {
<a name="l00036"></a>00036   <span class="keyword">public</span>:
<a name="l00038"></a><a class="code" href="a00107.html#af38900cea45dcbf966cbcd1cf865a7d">00038</a>     <span class="keyword">typedef</span> M <a class="code" href="a00107.html#af38900cea45dcbf966cbcd1cf865a7d" title="The matrix type the preconditioner is for.">matrix_type</a>;
<a name="l00040"></a><a class="code" href="a00107.html#59f2e9556c96324a04e48dfac217cae2">00040</a>     <span class="keyword">typedef</span> X <a class="code" href="a00107.html#59f2e9556c96324a04e48dfac217cae2" title="The domain type of the preconditioner.">domain_type</a>;
<a name="l00042"></a><a class="code" href="a00107.html#dd2f0c8d6f71026a43df57aac2453744">00042</a>     <span class="keyword">typedef</span> Y <a class="code" href="a00107.html#dd2f0c8d6f71026a43df57aac2453744" title="The range type of the preconditioner.">range_type</a>;
<a name="l00044"></a><a class="code" href="a00107.html#e602935c536089eb0e8ed31b6f2c3b4c">00044</a>     <span class="keyword">typedef</span> <span class="keyword">typename</span> X::field_type <a class="code" href="a00107.html#e602935c536089eb0e8ed31b6f2c3b4c" title="The field type of the preconditioner.">field_type</a>;
<a name="l00045"></a>00045     
<a name="l00046"></a>00046     <span class="keyword">typedef</span> <span class="keyword">typename</span> M::RowIterator RowIterator;
<a name="l00047"></a>00047     <span class="keyword">typedef</span> <span class="keyword">typename</span> M::ColIterator ColIterator;
<a name="l00048"></a>00048 
<a name="l00049"></a>00049     <span class="comment">// define the category</span>
<a name="l00050"></a>00050     <span class="keyword">enum</span> {
<a name="l00052"></a><a class="code" href="a00107.html#7c64733cd70eecf675dca59e880048491df1f37dd938f55649650733456a2847">00052</a>       <a class="code" href="a00107.html#7c64733cd70eecf675dca59e880048491df1f37dd938f55649650733456a2847" title="The category the preconditioner is part of.">category</a>=<a class="code" href="a00114.html#c8ffad5e3e40145669da6089b16c9574dd8be425650b870002d9381aea1203b9" title="Category for sequential solvers.">SolverCategory::sequential</a>
<a name="l00053"></a>00053     };
<a name="l00054"></a>00054 
<a name="l00062"></a><a class="code" href="a00107.html#bd1feb922a3b35b14f17dab8fb258db9">00062</a>     <a class="code" href="a00107.html#bd1feb922a3b35b14f17dab8fb258db9" title="Constructor.">SeqPardiso</a> (<span class="keyword">const</span> M&amp; A)
<a name="l00063"></a>00063       : A_(A)
<a name="l00064"></a>00064     {
<a name="l00065"></a>00065 <span class="preprocessor">#ifdef HAVE_PARDISO</span>
<a name="l00066"></a>00066 <span class="preprocessor"></span>        
<a name="l00067"></a>00067         mtype_ = 11;
<a name="l00068"></a>00068         nrhs_ = 1;
<a name="l00069"></a>00069         num_procs_ = 1;
<a name="l00070"></a>00070         maxfct_ = 1;    
<a name="l00071"></a>00071         mnum_   = 1;         
<a name="l00072"></a>00072         msglvl_ = 0;        
<a name="l00073"></a>00073         error_  = 0;        
<a name="l00074"></a>00074 
<a name="l00075"></a>00075         n_ = A_.rowdim();
<a name="l00076"></a>00076         <span class="keywordtype">int</span> nnz = 0;
<a name="l00077"></a>00077         RowIterator endi = A_.end();
<a name="l00078"></a>00078         <span class="keywordflow">for</span> (RowIterator i = A_.begin(); i != endi; ++i)
<a name="l00079"></a>00079         {
<a name="l00080"></a>00080                 <span class="keywordflow">if</span> (A_.rowdim(i.index()) != 1)
<a name="l00081"></a>00081                         DUNE_THROW(NotImplemented, <span class="stringliteral">"SeqPardiso: row blocksize != 1."</span>);
<a name="l00082"></a>00082                 ColIterator endj = (*i).end();
<a name="l00083"></a>00083                 <span class="keywordflow">for</span> (ColIterator j = (*i).begin(); j != endj; ++j) {
<a name="l00084"></a>00084                         <span class="keywordflow">if</span> (A_.coldim(j.index()) != 1)
<a name="l00085"></a>00085                                 DUNE_THROW(NotImplemented, <span class="stringliteral">"SeqPardiso: column blocksize != 1."</span>);
<a name="l00086"></a>00086                         nnz++;
<a name="l00087"></a>00087                 }
<a name="l00088"></a>00088         }
<a name="l00089"></a>00089                   
<a name="l00090"></a>00090         std::cout &lt;&lt; <span class="stringliteral">"dimension = "</span> &lt;&lt; n_ &lt;&lt; <span class="stringliteral">", number of nonzeros = "</span> &lt;&lt; nnz &lt;&lt; std::endl;
<a name="l00091"></a>00091         
<a name="l00092"></a>00092         a_ = <span class="keyword">new</span> <span class="keywordtype">double</span>[nnz];
<a name="l00093"></a>00093         ia_ = <span class="keyword">new</span> <span class="keywordtype">int</span>[n_+1];
<a name="l00094"></a>00094         ja_ = <span class="keyword">new</span> <span class="keywordtype">int</span>[nnz];
<a name="l00095"></a>00095         
<a name="l00096"></a>00096         <span class="keywordtype">int</span> count = 0;
<a name="l00097"></a>00097         <span class="keywordflow">for</span> (RowIterator i = A_.begin(); i != endi; ++i)
<a name="l00098"></a>00098         {
<a name="l00099"></a>00099                 ia_[i.index()] = count+1;
<a name="l00100"></a>00100                 ColIterator endj = (*i).end();
<a name="l00101"></a>00101                 <span class="keywordflow">for</span> (ColIterator j = (*i).begin(); j != endj; ++j) {
<a name="l00102"></a>00102                         a_[count] = *j;
<a name="l00103"></a>00103                         ja_[count] = j.index()+1;
<a name="l00104"></a>00104                         
<a name="l00105"></a>00105                         count++;
<a name="l00106"></a>00106                 }
<a name="l00107"></a>00107         }
<a name="l00108"></a>00108         ia_[n_] = count+1;
<a name="l00109"></a>00109         
<a name="l00110"></a>00110         F77_FUNC(pardisoinit) (pt_,  &amp;mtype_, iparm_); 
<a name="l00111"></a>00111 
<a name="l00112"></a>00112         <span class="keywordtype">int</span> phase = 11;
<a name="l00113"></a>00113         <span class="keywordtype">int</span> idum;
<a name="l00114"></a>00114         <span class="keywordtype">double</span> ddum;
<a name="l00115"></a>00115         iparm_[2]  = num_procs_;
<a name="l00116"></a>00116         
<a name="l00117"></a>00117         F77_FUNC(pardiso) (pt_, &amp;maxfct_, &amp;mnum_, &amp;mtype_, &amp;phase,
<a name="l00118"></a>00118                        &amp;n_, a_, ia_, ja_, &amp;idum, &amp;nrhs_,
<a name="l00119"></a>00119                        iparm_, &amp;msglvl_, &amp;ddum, &amp;ddum, &amp;error_);
<a name="l00120"></a>00120       
<a name="l00121"></a>00121         <span class="keywordflow">if</span> (error_ != 0) 
<a name="l00122"></a>00122                 DUNE_THROW(MathError, <span class="stringliteral">"Constructor SeqPardiso: Factorization failed. Error code "</span> &lt;&lt; error_);
<a name="l00123"></a>00123         
<a name="l00124"></a>00124         std::cout &lt;&lt; <span class="stringliteral">"Constructor SeqPardiso: Factorization completed."</span> &lt;&lt; std::endl;
<a name="l00125"></a>00125         
<a name="l00126"></a>00126 <span class="preprocessor">#else</span>
<a name="l00127"></a>00127 <span class="preprocessor"></span>        DUNE_THROW(NotImplemented, <span class="stringliteral">"no Pardiso library available, reconfigure with correct --with-pardiso options"</span>);
<a name="l00128"></a>00128 <span class="preprocessor">#endif</span>
<a name="l00129"></a>00129 <span class="preprocessor"></span>    }
<a name="l00130"></a>00130 
<a name="l00136"></a><a class="code" href="a00107.html#31ad9e77208de73954521ab1df57ccb4">00136</a>     <span class="keyword">virtual</span> <span class="keywordtype">void</span> <a class="code" href="a00107.html#31ad9e77208de73954521ab1df57ccb4" title="Prepare the preconditioner.">pre</a> (X&amp; x, Y&amp; b) {}
<a name="l00137"></a>00137 
<a name="l00143"></a><a class="code" href="a00107.html#80704d36ba017caf8bcaaf95e2a19d7c">00143</a>     <span class="keyword">virtual</span> <span class="keywordtype">void</span> <a class="code" href="a00107.html#80704d36ba017caf8bcaaf95e2a19d7c" title="Apply the preconditioner.">apply</a> (X&amp; v, <span class="keyword">const</span> Y&amp; d)
<a name="l00144"></a>00144     {
<a name="l00145"></a>00145 <span class="preprocessor">#ifdef HAVE_PARDISO</span>
<a name="l00146"></a>00146 <span class="preprocessor"></span>        <span class="keywordtype">int</span> phase = 33;
<a name="l00147"></a>00147 
<a name="l00148"></a>00148         iparm_[7] = 1;       <span class="comment">/* Max numbers of iterative refinement steps. */</span>
<a name="l00149"></a>00149         <span class="keywordtype">int</span> idum;
<a name="l00150"></a>00150 
<a name="l00151"></a>00151         <span class="keywordtype">double</span> x[n_];
<a name="l00152"></a>00152         <span class="keywordtype">double</span> b[n_];
<a name="l00153"></a>00153         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; n_; i++) {
<a name="l00154"></a>00154                 x[i] = v[i];
<a name="l00155"></a>00155                 b[i] = d[i];
<a name="l00156"></a>00156         }
<a name="l00157"></a>00157         
<a name="l00158"></a>00158         F77_FUNC(pardiso) (pt_, &amp;maxfct_, &amp;mnum_, &amp;mtype_, &amp;phase,
<a name="l00159"></a>00159                        &amp;n_, a_, ia_, ja_, &amp;idum, &amp;nrhs_,
<a name="l00160"></a>00160                        iparm_, &amp;msglvl_, b, x, &amp;error_);
<a name="l00161"></a>00161         
<a name="l00162"></a>00162         <span class="keywordflow">if</span> (error_ != 0) 
<a name="l00163"></a>00163                 DUNE_THROW(MathError, <span class="stringliteral">"SeqPardiso.apply: Backsolve failed. Error code "</span> &lt;&lt; error_);
<a name="l00164"></a>00164         
<a name="l00165"></a>00165         <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; n_; i++) 
<a name="l00166"></a>00166                 v[i] = x[i];
<a name="l00167"></a>00167         
<a name="l00168"></a>00168         std::cout &lt;&lt; <span class="stringliteral">"SeqPardiso: Backsolve completed."</span> &lt;&lt; std::endl;
<a name="l00169"></a>00169 <span class="preprocessor">#endif</span>
<a name="l00170"></a>00170 <span class="preprocessor"></span>    }
<a name="l00171"></a>00171 
<a name="l00177"></a><a class="code" href="a00107.html#2814842a6559852f52fabc79630a22a5">00177</a>     <span class="keyword">virtual</span> <span class="keywordtype">void</span> <a class="code" href="a00107.html#2814842a6559852f52fabc79630a22a5" title="Clean up.">post</a> (X&amp; x) {}
<a name="l00178"></a>00178 
<a name="l00179"></a>00179     ~<a class="code" href="a00107.html" title="The sequential Pardiso preconditioner.">SeqPardiso</a>() 
<a name="l00180"></a>00180     {
<a name="l00181"></a>00181 <span class="preprocessor">#ifdef HAVE_PARDISO</span>
<a name="l00182"></a>00182 <span class="preprocessor"></span>        <span class="keywordtype">int</span> phase = -1;                 <span class="comment">// Release internal memory. </span>
<a name="l00183"></a>00183         <span class="keywordtype">int</span> idum;
<a name="l00184"></a>00184         <span class="keywordtype">double</span> ddum;
<a name="l00185"></a>00185 
<a name="l00186"></a>00186         F77_FUNC(pardiso) (pt_, &amp;maxfct_, &amp;mnum_, &amp;mtype_, &amp;phase,
<a name="l00187"></a>00187                        &amp;n_, &amp;ddum, ia_, ja_, &amp;idum, &amp;nrhs_,
<a name="l00188"></a>00188                        iparm_, &amp;msglvl_, &amp;ddum, &amp;ddum, &amp;error_);
<a name="l00189"></a>00189         <span class="keyword">delete</span>[] a_;
<a name="l00190"></a>00190         <span class="keyword">delete</span>[] ia_;
<a name="l00191"></a>00191         <span class="keyword">delete</span>[] ja_;
<a name="l00192"></a>00192 <span class="preprocessor">#endif</span>
<a name="l00193"></a>00193 <span class="preprocessor"></span>    }
<a name="l00194"></a>00194   
<a name="l00195"></a>00195   <span class="keyword">private</span>:
<a name="l00196"></a>00196     M A_; 
<a name="l00197"></a>00197     <span class="keywordtype">int</span> n_; 
<a name="l00198"></a>00198     <span class="keywordtype">double</span> *a_; 
<a name="l00199"></a>00199     <span class="keywordtype">int</span> *ia_; 
<a name="l00200"></a>00200     <span class="keywordtype">int</span> *ja_; 
<a name="l00201"></a>00201     <span class="keywordtype">int</span> mtype_; 
<a name="l00202"></a>00202     <span class="keywordtype">int</span> nrhs_; 
<a name="l00203"></a>00203     <span class="keywordtype">void</span> *pt_[64]; 
<a name="l00204"></a>00204     <span class="keywordtype">int</span> iparm_[64]; 
<a name="l00205"></a>00205     <span class="keywordtype">int</span> maxfct_;        
<a name="l00206"></a>00206     <span class="keywordtype">int</span> mnum_;  
<a name="l00207"></a>00207     <span class="keywordtype">int</span> msglvl_;    
<a name="l00208"></a>00208     <span class="keywordtype">int</span> error_;      
<a name="l00209"></a>00209     <span class="keywordtype">int</span> num_procs_; 
<a name="l00210"></a>00210   };
<a name="l00211"></a>00211 
<a name="l00212"></a>00212 }
<a name="l00213"></a>00213 
<a name="l00214"></a>00214 
<a name="l00215"></a>00215 
<a name="l00216"></a>00216 
<a name="l00217"></a>00217 
<a name="l00218"></a>00218 
<a name="l00219"></a>00219 <span class="preprocessor">#endif</span>
<a name="l00220"></a>00220 <span class="preprocessor"></span>
</pre></div></div>
</div> <!-- end doxygen -->
</div> <!-- end main -->
<div class="foot">

<p class="foot">
  Generated on 6 Nov 2008 with <a
  href="http://www.doxygen.org/">Doxygen</a> (ver 1.5.6)  
  [<a href="doxygen.log">logfile</a>].
</p>

</div>

</body>
</html>
