<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN""http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<title>dune-istl: interface.hh Source File (dune-istl )</title>
  <link rel="stylesheet" type="text/css" href="./dune-doxy.css">
  <link rel="stylesheet" type="text/css" href="./tabs.css">
</head>
<div class="main">
<div class="doxygen">
<!-- Generated by Doxygen 1.5.6 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="classes.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div class="navpath"><a class="el" href="dir_39c25fa0261c9359275e2f8975608afb.html">istl</a>
  </div>
</div>
<div class="contents">
<h1>interface.hh</h1><a href="a00156.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">// $Id: interface.hh 954 2008-10-28 10:31:55Z robertk $</span>
<a name="l00002"></a>00002 <span class="preprocessor">#ifndef DUNE_INTERFACE_HH</span>
<a name="l00003"></a>00003 <span class="preprocessor"></span><span class="preprocessor">#define DUNE_INTERFACE_HH</span>
<a name="l00004"></a>00004 <span class="preprocessor"></span>
<a name="l00005"></a>00005 <span class="preprocessor">#include"<a class="code" href="a00175.html" title="Classes discribing a distributed indexset.">remoteindices.hh</a>"</span>
<a name="l00006"></a>00006 <span class="preprocessor">#include&lt;dune/common/enumset.hh&gt;</span>
<a name="l00007"></a>00007 <span class="keyword">namespace </span>Dune
<a name="l00008"></a>00008 {
<a name="l00028"></a>00028   <span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;
<a name="l00029"></a><a class="code" href="a00061.html">00029</a>   <span class="keyword">class </span><a class="code" href="a00061.html" title="Base class of all classes representing a communication interface.">InterfaceBuilder</a>
<a name="l00030"></a>00030   {
<a name="l00031"></a>00031   <span class="keyword">public</span>: 
<a name="l00032"></a>00032     
<a name="l00036"></a><a class="code" href="a00061.html#79298ef5923a180d0a37f25d1a4b8d6f">00036</a>     <span class="keyword">typedef</span> T <a class="code" href="a00087.html" title="Manager class for the mapping between local indices and globally unique indices.">ParallelIndexSet</a>;
<a name="l00037"></a>00037     
<a name="l00041"></a><a class="code" href="a00061.html#ceb3145987e389bb19330f73f5d00343">00041</a>     <span class="keyword">typedef</span> Dune :: RemoteIndices&lt;ParallelIndexSet&gt; <a class="code" href="a00097.html" title="The indices present on remote processes.">RemoteIndices</a>;
<a name="l00042"></a>00042 
<a name="l00046"></a><a class="code" href="a00061.html#874d7bac7541a160734b82de5e105d4f">00046</a>     <span class="keyword">typedef</span> <span class="keyword">typename</span> <a class="code" href="a00097.html#2d71744ec861972e0445ad7151a2beaa" title="The type of the global index.">RemoteIndices::GlobalIndex</a> <a class="code" href="a00061.html#874d7bac7541a160734b82de5e105d4f" title="The type of the global index.">GlobalIndex</a>;
<a name="l00047"></a>00047     
<a name="l00051"></a><a class="code" href="a00061.html#e1cb3d9539a0f90e1d389ccad803d9b8">00051</a>     <span class="keyword">typedef</span> <span class="keyword">typename</span> <a class="code" href="a00097.html#84fb8948c64df9253b2b4582b650808d" title="The type of the attribute.">RemoteIndices::Attribute</a> <a class="code" href="a00061.html#e1cb3d9539a0f90e1d389ccad803d9b8" title="The type of the attribute.">Attribute</a>;
<a name="l00052"></a>00052     
<a name="l00053"></a>00053     <span class="keyword">virtual</span> ~<a class="code" href="a00061.html" title="Base class of all classes representing a communication interface.">InterfaceBuilder</a>()
<a name="l00054"></a>00054     {}
<a name="l00055"></a>00055 
<a name="l00056"></a>00056   <span class="keyword">protected</span>:
<a name="l00060"></a><a class="code" href="a00061.html#797a62e62205aa8cff189d249fc4a178">00060</a>     <a class="code" href="a00061.html#797a62e62205aa8cff189d249fc4a178" title="Not for public use.">InterfaceBuilder</a>()
<a name="l00061"></a>00061     {}
<a name="l00062"></a>00062     
<a name="l00100"></a>00100     <span class="keyword">template</span>&lt;<span class="keyword">class</span> T1, <span class="keyword">class</span> T2, <span class="keyword">class</span> Op, <span class="keywordtype">bool</span> send&gt;
<a name="l00101"></a>00101     <span class="keywordtype">void</span> <a class="code" href="a00195.html#g2ec46f5af09aa30f8884dbc284d25a3a" title="Builds the interface between remote processes.">buildInterface</a> (<span class="keyword">const</span> <a class="code" href="a00097.html" title="The indices present on remote processes.">RemoteIndices</a>&amp; remoteIndices, 
<a name="l00102"></a>00102                          <span class="keyword">const</span> T1&amp; sourceFlags, <span class="keyword">const</span> T2&amp; destFlags,
<a name="l00103"></a>00103                          Op&amp; functor) <span class="keyword">const</span>;
<a name="l00104"></a>00104   };
<a name="l00105"></a>00105   
<a name="l00113"></a><a class="code" href="a00062.html">00113</a>   <span class="keyword">class </span><a class="code" href="a00062.html" title="Information describing an interface.">InterfaceInformation</a>
<a name="l00114"></a>00114   {
<a name="l00115"></a>00115     
<a name="l00116"></a>00116   <span class="keyword">public</span>:
<a name="l00117"></a>00117     
<a name="l00121"></a><a class="code" href="a00062.html#e8863c2780ec2be39bf0fe7577beff6f">00121</a>     <span class="keywordtype">size_t</span> <a class="code" href="a00062.html#e8863c2780ec2be39bf0fe7577beff6f" title="Get the number of entries in the interface.">size</a>()<span class="keyword"> const</span>
<a name="l00122"></a>00122 <span class="keyword">    </span>{
<a name="l00123"></a>00123       <span class="keywordflow">return</span> size_;
<a name="l00124"></a>00124     }
<a name="l00129"></a><a class="code" href="a00062.html#812c95e202f994ccd6edca6aa7de37aa">00129</a>     uint32_t&amp; <a class="code" href="a00062.html#812c95e202f994ccd6edca6aa7de37aa" title="Get the local index for an entry.">operator[]</a>(<span class="keywordtype">size_t</span> i)
<a name="l00130"></a>00130     {
<a name="l00131"></a>00131       assert(i&lt;size_);
<a name="l00132"></a>00132       <span class="keywordflow">return</span> indices_[i];
<a name="l00133"></a>00133     }
<a name="l00138"></a><a class="code" href="a00062.html#c90b2abec49c8d3fab0fc3c839821559">00138</a>     uint32_t <a class="code" href="a00062.html#812c95e202f994ccd6edca6aa7de37aa" title="Get the local index for an entry.">operator[]</a>(<span class="keywordtype">size_t</span> i)<span class="keyword"> const</span>
<a name="l00139"></a>00139 <span class="keyword">    </span>{
<a name="l00140"></a>00140       assert(i&lt;size_);
<a name="l00141"></a>00141       <span class="keywordflow">return</span> indices_[i];
<a name="l00142"></a>00142     }
<a name="l00147"></a><a class="code" href="a00062.html#e4d44498ce2f25d30fe10d52a8c0b682">00147</a>     <span class="keywordtype">void</span> <a class="code" href="a00062.html#e4d44498ce2f25d30fe10d52a8c0b682" title="Reserve space for a number of entries.">reserve</a>(<span class="keywordtype">size_t</span> <a class="code" href="a00062.html#e8863c2780ec2be39bf0fe7577beff6f" title="Get the number of entries in the interface.">size</a>)
<a name="l00148"></a>00148     {
<a name="l00149"></a>00149       indices_ = <span class="keyword">new</span> uint32_t[size];
<a name="l00150"></a>00150       maxSize_ = size;
<a name="l00151"></a>00151       
<a name="l00152"></a>00152     }
<a name="l00156"></a><a class="code" href="a00062.html#34fc2f7d08e7812ae7e74c5a76317cce">00156</a>     <span class="keywordtype">void</span> <a class="code" href="a00062.html#34fc2f7d08e7812ae7e74c5a76317cce">free</a>()
<a name="l00157"></a>00157     {
<a name="l00158"></a>00158       <span class="keyword">delete</span>[] indices_;
<a name="l00159"></a>00159       maxSize_ = 0;
<a name="l00160"></a>00160       size_=0;
<a name="l00161"></a>00161       indices_=0;
<a name="l00162"></a>00162     }
<a name="l00166"></a><a class="code" href="a00062.html#10edc15256c3f4fd3b89aaf8f379cf79">00166</a>     <span class="keywordtype">void</span> <span class="keyword">add</span>(uint32_t index)
<a name="l00167"></a>00167     {
<a name="l00168"></a>00168       assert(size_&lt;maxSize_);
<a name="l00169"></a>00169       indices_[size_++]=index;
<a name="l00170"></a>00170     }
<a name="l00171"></a>00171     
<a name="l00172"></a>00172     <a class="code" href="a00062.html" title="Information describing an interface.">InterfaceInformation</a>() 
<a name="l00173"></a>00173       : size_(0), maxSize_(0), indices_(0)
<a name="l00174"></a>00174     {}
<a name="l00175"></a>00175     
<a name="l00176"></a>00176     <span class="keyword">virtual</span> ~InterfaceInformation()
<a name="l00177"></a>00177     {
<a name="l00178"></a>00178       <span class="keywordflow">if</span>(indices_!=0){
<a name="l00179"></a>00179         std::cerr&lt;&lt;<span class="stringliteral">"InterfaceInformation::free() should be called before "</span>&lt;&lt;
<a name="l00180"></a>00180           <span class="stringliteral">"destructor!"</span>&lt;&lt;std::endl;
<a name="l00181"></a>00181       }
<a name="l00182"></a>00182       
<a name="l00183"></a>00183     }
<a name="l00184"></a>00184 
<a name="l00185"></a>00185   <span class="keyword">private</span>:
<a name="l00189"></a>00189     <span class="keywordtype">size_t</span> size_;
<a name="l00193"></a>00193     <span class="keywordtype">size_t</span> maxSize_;
<a name="l00197"></a>00197     uint32_t* indices_;
<a name="l00198"></a>00198   };
<a name="l00199"></a>00199 
<a name="l00211"></a>00211   <span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;
<a name="l00212"></a><a class="code" href="a00060.html">00212</a>   <span class="keyword">class </span><a class="code" href="a00060.html" title="Communication interface between remote and local indices.">Interface</a> : <span class="keyword">public</span> <a class="code" href="a00061.html" title="Base class of all classes representing a communication interface.">InterfaceBuilder</a>&lt;T&gt;
<a name="l00213"></a>00213   {
<a name="l00214"></a>00214     
<a name="l00215"></a>00215   <span class="keyword">public</span>:
<a name="l00216"></a>00216     <span class="keyword">typedef</span> <a class="code" href="a00062.html" title="Information describing an interface.">InterfaceInformation</a> <a class="code" href="a00062.html" title="Information describing an interface.">Information</a>;
<a name="l00217"></a>00217 
<a name="l00218"></a>00218     <span class="keyword">typedef</span> std::map&lt;int,std::pair&lt;Information,Information&gt; &gt; InformationMap;
<a name="l00219"></a>00219 
<a name="l00223"></a><a class="code" href="a00060.html#9aa4f02525c413f9381d425ecf12b79a">00223</a>     <span class="keyword">typedef</span> T <a class="code" href="a00087.html" title="Manager class for the mapping between local indices and globally unique indices.">ParallelIndexSet</a>;
<a name="l00224"></a>00224 
<a name="l00228"></a><a class="code" href="a00060.html#7aa2b4a19c7cffc867a946b330dcb2a7">00228</a>     <span class="keyword">typedef</span> Dune :: RemoteIndices&lt;ParallelIndexSet&gt; <a class="code" href="a00097.html" title="The indices present on remote processes.">RemoteIndices</a>;
<a name="l00229"></a>00229     
<a name="l00230"></a>00230 
<a name="l00234"></a><a class="code" href="a00060.html#1df8ab915832a9247d84c4ed098d4a64">00234</a>     <span class="keyword">typedef</span> <span class="keyword">typename</span> <a class="code" href="a00097.html#2d71744ec861972e0445ad7151a2beaa" title="The type of the global index.">RemoteIndices::GlobalIndex</a> <a class="code" href="a00060.html#1df8ab915832a9247d84c4ed098d4a64" title="The type of the global index.">GlobalIndex</a>;
<a name="l00235"></a>00235     
<a name="l00239"></a><a class="code" href="a00060.html#8c14b4bdcf597b003b00c7d460e24343">00239</a>     <span class="keyword">typedef</span> <span class="keyword">typename</span> <a class="code" href="a00097.html#84fb8948c64df9253b2b4582b650808d" title="The type of the attribute.">RemoteIndices::Attribute</a> <a class="code" href="a00060.html#8c14b4bdcf597b003b00c7d460e24343" title="The type of the attribute.">Attribute</a>;
<a name="l00240"></a>00240     
<a name="l00257"></a>00257     <span class="keyword">template</span>&lt;<span class="keyword">typename</span> T1, <span class="keyword">typename</span> T2&gt;
<a name="l00258"></a>00258     <span class="keywordtype">void</span> <a class="code" href="a00195.html#g5d3351c8857ba5cfdd74d28bb5725a30" title="Builds the interface.">build</a>(<span class="keyword">const</span> <a class="code" href="a00097.html" title="The indices present on remote processes.">RemoteIndices</a>&amp; remoteIndices, <span class="keyword">const</span> T1&amp; sourceFlags, 
<a name="l00259"></a>00259                <span class="keyword">const</span> T2&amp; destFlags);
<a name="l00260"></a>00260 
<a name="l00264"></a>00264     <span class="keywordtype">void</span> <a class="code" href="a00195.html#g7998a5cc771852a49c8833b52e82a0ba" title="Frees memory allocated during the build.">free</a>();
<a name="l00265"></a>00265 
<a name="l00269"></a>00269     MPI_Comm <a class="code" href="a00195.html#g34977a3d4cd57e1357c8829b0babad6a" title="Get the MPI Communicator.">communicator</a>() <span class="keyword">const</span>;
<a name="l00270"></a>00270 
<a name="l00279"></a>00279     <span class="keyword">const</span> InformationMap&amp; <a class="code" href="a00195.html#gb090953b7eb31e5c8be6e9667ba13c76" title="Get information about the interfaces.">interfaces</a>() <span class="keyword">const</span>;
<a name="l00280"></a>00280     
<a name="l00281"></a>00281     <a class="code" href="a00060.html" title="Communication interface between remote and local indices.">Interface</a>()
<a name="l00282"></a>00282       : interfaces_()
<a name="l00283"></a>00283     {}
<a name="l00284"></a>00284     
<a name="l00288"></a>00288     <span class="keywordtype">void</span> <a class="code" href="a00195.html#g1645b178ff6cf59d9013f4029327eb9f" title="Print the interface to std::out for debugging.">print</a>() <span class="keyword">const</span>;
<a name="l00289"></a>00289     
<a name="l00293"></a>00293     <span class="keyword">virtual</span> <a class="code" href="a00195.html#gb19c7dee343bf007f23da5eb62d97436" title="Destructor.">~Interface</a>();
<a name="l00294"></a>00294     
<a name="l00295"></a>00295   <span class="keyword">private</span>:
<a name="l00299"></a>00299     <span class="keyword">const</span> <a class="code" href="a00097.html" title="The indices present on remote processes.">RemoteIndices</a>* remoteIndices_;
<a name="l00300"></a>00300     
<a name="l00308"></a>00308     InformationMap interfaces_;
<a name="l00309"></a>00309     
<a name="l00310"></a>00310     <span class="keyword">template</span>&lt;<span class="keywordtype">bool</span> send&gt;
<a name="l00311"></a>00311     <span class="keyword">class </span>InformationBuilder
<a name="l00312"></a>00312     {
<a name="l00313"></a>00313     <span class="keyword">public</span>:
<a name="l00314"></a>00314       InformationBuilder(InformationMap&amp; <a class="code" href="a00195.html#gb090953b7eb31e5c8be6e9667ba13c76" title="Get information about the interfaces.">interfaces</a>)
<a name="l00315"></a>00315         : interfaces_(interfaces)
<a name="l00316"></a>00316       {}
<a name="l00317"></a>00317       
<a name="l00318"></a>00318       <span class="keywordtype">void</span> reserve(<span class="keywordtype">int</span> proc, <span class="keywordtype">int</span> size)
<a name="l00319"></a>00319       {
<a name="l00320"></a>00320         <span class="keywordflow">if</span>(send)
<a name="l00321"></a>00321           interfaces_[proc].first.reserve(size);
<a name="l00322"></a>00322         <span class="keywordflow">else</span>
<a name="l00323"></a>00323           interfaces_[proc].second.reserve(size);
<a name="l00324"></a>00324       }
<a name="l00325"></a>00325       <span class="keywordtype">void</span> <span class="keyword">add</span>(<span class="keywordtype">int</span> proc, <span class="keywordtype">int</span> local)
<a name="l00326"></a>00326       {
<a name="l00327"></a>00327         <span class="keywordflow">if</span>(send){
<a name="l00328"></a>00328           interfaces_[proc].first.add(local);
<a name="l00329"></a>00329         }<span class="keywordflow">else</span>{
<a name="l00330"></a>00330           interfaces_[proc].second.add(local);
<a name="l00331"></a>00331         }
<a name="l00332"></a>00332       }
<a name="l00333"></a>00333       
<a name="l00334"></a>00334     <span class="keyword">private</span>:
<a name="l00335"></a>00335       InformationMap&amp; interfaces_;
<a name="l00336"></a>00336     };
<a name="l00337"></a>00337   };
<a name="l00338"></a>00338   
<a name="l00339"></a>00339   <span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;
<a name="l00340"></a>00340   <span class="keyword">template</span>&lt;<span class="keyword">class</span> T1, <span class="keyword">class</span> T2, <span class="keyword">class</span> Op, <span class="keywordtype">bool</span> send&gt;
<a name="l00341"></a><a class="code" href="a00195.html#g2ec46f5af09aa30f8884dbc284d25a3a">00341</a>   <span class="keywordtype">void</span> <a class="code" href="a00061.html" title="Base class of all classes representing a communication interface.">InterfaceBuilder&lt;T&gt;::buildInterface</a>(<span class="keyword">const</span> <a class="code" href="a00097.html" title="The indices present on remote processes.">RemoteIndices</a>&amp; remoteIndices, <span class="keyword">const</span> T1&amp; sourceFlags, <span class="keyword">const</span> T2&amp; destFlags, Op&amp; interfaceInformation)<span class="keyword"> const</span>
<a name="l00342"></a>00342 <span class="keyword">  </span>{
<a name="l00343"></a>00343     <span class="comment">// Allocate the memory for the data type construction.</span>
<a name="l00344"></a>00344     <span class="keyword">typedef</span> <span class="keyword">typename</span> RemoteIndices::RemoteIndexMap::const_iterator const_iterator;
<a name="l00345"></a>00345     <span class="keyword">typedef</span> <span class="keyword">typename</span> RemoteIndices::ParallelIndexSet::const_iterator LocalIterator;
<a name="l00346"></a>00346 
<a name="l00347"></a>00347     <span class="keyword">const</span> const_iterator end=remoteIndices.<a class="code" href="a00097.html#4c5ea85d4ba9a4b46ac9a9ff29ee5e64" title="Get an iterator over all remote index lists.">end</a>();
<a name="l00348"></a>00348     
<a name="l00349"></a>00349     <span class="keywordtype">int</span> rank;
<a name="l00350"></a>00350     
<a name="l00351"></a>00351     MPI_Comm_rank(remoteIndices.<a class="code" href="a00097.html#2305368bbbd8bc7ee2fd330ed21b65fb" title="Get the mpi communicator used.">communicator</a>(), &amp;rank);
<a name="l00352"></a>00352     
<a name="l00353"></a>00353     <span class="comment">// Allocate memory for the type construction.</span>
<a name="l00354"></a>00354     <span class="keywordflow">for</span>(const_iterator process=remoteIndices.<a class="code" href="a00097.html#9ddfb44c51fd6349bf8aad8ae79548bd" title="Get an iterator over all remote index lists.">begin</a>(); process != end; ++process){
<a name="l00355"></a>00355       <span class="comment">// Messure the number of indices send to the remote process first</span>
<a name="l00356"></a>00356       <span class="keywordtype">int</span> size=0;
<a name="l00357"></a>00357       LocalIterator localIndex = send ? remoteIndices.<a class="code" href="a00097.html#6e7e4287fe920c0d9d942fe62ff23180" title="Index set used at the source of the communication.">source_</a>-&gt;<a class="code" href="a00195.html#g1f7489201417827fc547818553c1d57b" title="Get an iterator over the indices positioned at the first index.">begin</a>() : remoteIndices.<a class="code" href="a00097.html#fc93186dca36720c75e69b0dcf577a73" title="Index set used at the destination of the communication.">target_</a>-&gt;<a class="code" href="a00195.html#g1f7489201417827fc547818553c1d57b" title="Get an iterator over the indices positioned at the first index.">begin</a>();
<a name="l00358"></a>00358       <span class="keyword">const</span> LocalIterator localEnd = send ?  remoteIndices.<a class="code" href="a00097.html#6e7e4287fe920c0d9d942fe62ff23180" title="Index set used at the source of the communication.">source_</a>-&gt;<a class="code" href="a00195.html#g76c8b73b6353cde82b8877ac982a17ae" title="Get an iterator over the indices positioned after the last index.">end</a>() : remoteIndices.<a class="code" href="a00097.html#fc93186dca36720c75e69b0dcf577a73" title="Index set used at the destination of the communication.">target_</a>-&gt;<a class="code" href="a00195.html#g76c8b73b6353cde82b8877ac982a17ae" title="Get an iterator over the indices positioned after the last index.">end</a>();
<a name="l00359"></a>00359       <span class="keyword">typedef</span> <span class="keyword">typename</span> RemoteIndices::RemoteIndexList::const_iterator RemoteIterator;
<a name="l00360"></a>00360       <span class="keyword">const</span> RemoteIterator remoteEnd = send ? process-&gt;second.first-&gt;end() : 
<a name="l00361"></a>00361         process-&gt;second.second-&gt;end();
<a name="l00362"></a>00362       RemoteIterator remote = send ? process-&gt;second.first-&gt;begin() : process-&gt;second.second-&gt;begin();
<a name="l00363"></a>00363         
<a name="l00364"></a>00364       <span class="keywordflow">while</span>(localIndex!=localEnd &amp;&amp; remote!=remoteEnd){
<a name="l00365"></a>00365           <span class="keywordflow">if</span>( send ?  destFlags.contains(remote-&gt;attribute()) :
<a name="l00366"></a>00366               sourceFlags.contains(remote-&gt;attribute())){
<a name="l00367"></a>00367             <span class="comment">// search for the matching local index</span>
<a name="l00368"></a>00368             <span class="keywordflow">while</span>(localIndex-&gt;global()&lt;remote-&gt;localIndexPair().global()){
<a name="l00369"></a>00369               localIndex++;
<a name="l00370"></a>00370               assert(localIndex != localEnd); <span class="comment">// Should never happen</span>
<a name="l00371"></a>00371             }
<a name="l00372"></a>00372             assert(localIndex-&gt;global()==remote-&gt;localIndexPair().global());
<a name="l00373"></a>00373             
<a name="l00374"></a>00374             <span class="comment">// do we send the index?</span>
<a name="l00375"></a>00375             <span class="keywordflow">if</span>( send ? sourceFlags.contains(localIndex-&gt;local().attribute()) :
<a name="l00376"></a>00376                 destFlags.contains(localIndex-&gt;local().attribute()))
<a name="l00377"></a>00377               ++size;
<a name="l00378"></a>00378           }
<a name="l00379"></a>00379           ++remote;
<a name="l00380"></a>00380       }
<a name="l00381"></a>00381       interfaceInformation.reserve(process-&gt;first, size);
<a name="l00382"></a>00382     }
<a name="l00383"></a>00383 
<a name="l00384"></a>00384     <span class="comment">// compare the local and remote indices and set up the types</span>
<a name="l00385"></a>00385     
<a name="l00386"></a>00386     <a class="code" href="a00028.html" title="A collective iterator for moving over the remote indices for all processes collectively...">CollectiveIterator&lt;T&gt;</a> remote = remoteIndices.template iterator&lt;send&gt;();
<a name="l00387"></a>00387     LocalIterator localIndex = send ? remoteIndices.<a class="code" href="a00097.html#6e7e4287fe920c0d9d942fe62ff23180" title="Index set used at the source of the communication.">source_</a>-&gt;<a class="code" href="a00195.html#g1f7489201417827fc547818553c1d57b" title="Get an iterator over the indices positioned at the first index.">begin</a>() : remoteIndices.<a class="code" href="a00097.html#fc93186dca36720c75e69b0dcf577a73" title="Index set used at the destination of the communication.">target_</a>-&gt;<a class="code" href="a00195.html#g1f7489201417827fc547818553c1d57b" title="Get an iterator over the indices positioned at the first index.">begin</a>();
<a name="l00388"></a>00388     <span class="keyword">const</span> LocalIterator localEnd = send ?  remoteIndices.<a class="code" href="a00097.html#6e7e4287fe920c0d9d942fe62ff23180" title="Index set used at the source of the communication.">source_</a>-&gt;<a class="code" href="a00195.html#g76c8b73b6353cde82b8877ac982a17ae" title="Get an iterator over the indices positioned after the last index.">end</a>() : remoteIndices.<a class="code" href="a00097.html#fc93186dca36720c75e69b0dcf577a73" title="Index set used at the destination of the communication.">target_</a>-&gt;<a class="code" href="a00195.html#g76c8b73b6353cde82b8877ac982a17ae" title="Get an iterator over the indices positioned after the last index.">end</a>();
<a name="l00389"></a>00389     
<a name="l00390"></a>00390     <span class="keywordflow">while</span>(localIndex!=localEnd &amp;&amp; !remote.<a class="code" href="a00028.html#27293e8991cc9e921cb4fe95f55fbe88" title="Checks whether there are still iterators in the map.">empty</a>()){
<a name="l00391"></a>00391       <span class="keywordflow">if</span>( send ? sourceFlags.contains(localIndex-&gt;local().attribute()) :
<a name="l00392"></a>00392           destFlags.contains(localIndex-&gt;local().attribute()))
<a name="l00393"></a>00393       {
<a name="l00394"></a>00394         <span class="comment">// search for matching remote indices</span>
<a name="l00395"></a>00395         remote.<a class="code" href="a00028.html#4b6709f61b483c033152f276f4f5d5a9" title="Advances all underlying iterators.">advance</a>(localIndex-&gt;global());
<a name="l00396"></a>00396         <span class="comment">// Iterate over the list that are positioned at global</span>
<a name="l00397"></a>00397         <span class="keyword">typedef</span> <span class="keyword">typename</span> <a class="code" href="a00028.html" title="A collective iterator for moving over the remote indices for all processes collectively...">CollectiveIterator&lt;T&gt;::iterator</a> ValidIterator;
<a name="l00398"></a>00398         <span class="keyword">const</span> ValidIterator end = remote.<a class="code" href="a00028.html#94151b38ae125e4aa133c90ba8a45bdb">end</a>();
<a name="l00399"></a>00399         ValidIterator validEntry = remote.<a class="code" href="a00028.html#6af0132f4c5be37ad68ab40eb42041b7">begin</a>();
<a name="l00400"></a>00400 
<a name="l00401"></a>00401         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0; validEntry != end; ++i){
<a name="l00402"></a>00402           <span class="keywordflow">if</span>( send ?  destFlags.contains(validEntry-&gt;attribute()) :
<a name="l00403"></a>00403               sourceFlags.contains(validEntry-&gt;attribute())){
<a name="l00404"></a>00404             <span class="comment">// We will receive data for this index</span>
<a name="l00405"></a>00405             interfaceInformation.add(validEntry.process(),localIndex-&gt;local());
<a name="l00406"></a>00406           }
<a name="l00407"></a>00407           ++validEntry;
<a name="l00408"></a>00408         }
<a name="l00409"></a>00409       }
<a name="l00410"></a>00410       ++localIndex;
<a name="l00411"></a>00411     }
<a name="l00412"></a>00412   }
<a name="l00413"></a>00413 
<a name="l00414"></a>00414   <span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;
<a name="l00415"></a><a class="code" href="a00195.html#g34977a3d4cd57e1357c8829b0babad6a">00415</a>   <span class="keyword">inline</span> MPI_Comm <a class="code" href="a00060.html" title="Communication interface between remote and local indices.">Interface&lt;T&gt;::communicator</a>()<span class="keyword"> const</span>
<a name="l00416"></a>00416 <span class="keyword">  </span>{
<a name="l00417"></a>00417     <span class="keywordflow">return</span> remoteIndices_-&gt;<a class="code" href="a00097.html#2305368bbbd8bc7ee2fd330ed21b65fb" title="Get the mpi communicator used.">communicator</a>();
<a name="l00418"></a>00418     
<a name="l00419"></a>00419   }
<a name="l00420"></a>00420   
<a name="l00421"></a>00421   <span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;
<a name="l00422"></a><a class="code" href="a00195.html#gb090953b7eb31e5c8be6e9667ba13c76">00422</a>   <span class="keyword">inline</span> <span class="keyword">const</span> std::map&lt;int,std::pair&lt;InterfaceInformation,InterfaceInformation&gt; &gt;&amp; <a class="code" href="a00060.html" title="Communication interface between remote and local indices.">Interface&lt;T&gt;::interfaces</a>()<span class="keyword"> const</span>
<a name="l00423"></a>00423 <span class="keyword">  </span>{
<a name="l00424"></a>00424     <span class="keywordflow">return</span> interfaces_;
<a name="l00425"></a>00425   }
<a name="l00426"></a>00426 
<a name="l00427"></a>00427   <span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;
<a name="l00428"></a><a class="code" href="a00195.html#g1645b178ff6cf59d9013f4029327eb9f">00428</a>   <span class="keywordtype">void</span> <a class="code" href="a00060.html" title="Communication interface between remote and local indices.">Interface&lt;T&gt;::print</a>()<span class="keyword"> const</span>
<a name="l00429"></a>00429 <span class="keyword">  </span>{
<a name="l00430"></a>00430     <span class="keyword">typedef</span> <span class="keyword">typename</span> InformationMap::const_iterator const_iterator;
<a name="l00431"></a>00431     <span class="keyword">const</span> const_iterator end=interfaces_.end();
<a name="l00432"></a>00432     <span class="keywordtype">int</span> rank;
<a name="l00433"></a>00433     MPI_Comm_rank(<a class="code" href="a00195.html#g34977a3d4cd57e1357c8829b0babad6a" title="Get the MPI Communicator.">communicator</a>(), &amp;rank);
<a name="l00434"></a>00434     
<a name="l00435"></a>00435     <span class="keywordflow">for</span>(const_iterator infoPair=interfaces_.begin(); infoPair!=end; ++infoPair){
<a name="l00436"></a>00436       {
<a name="l00437"></a>00437         std::cout&lt;&lt;rank&lt;&lt;<span class="stringliteral">": send for process "</span>&lt;&lt;infoPair-&gt;first&lt;&lt;<span class="stringliteral">": "</span>;
<a name="l00438"></a>00438         <span class="keyword">const</span> <a class="code" href="a00062.html" title="Information describing an interface.">InterfaceInformation</a>&amp; info(infoPair-&gt;second.first);
<a name="l00439"></a>00439         <span class="keywordflow">for</span>(<span class="keywordtype">size_t</span> i=0; i &lt; info.<a class="code" href="a00062.html#e8863c2780ec2be39bf0fe7577beff6f" title="Get the number of entries in the interface.">size</a>(); i++)
<a name="l00440"></a>00440           std::cout&lt;&lt;info[i]&lt;&lt;<span class="stringliteral">" "</span>;
<a name="l00441"></a>00441         std::cout&lt;&lt;std::endl;
<a name="l00442"></a>00442       }{
<a name="l00443"></a>00443         
<a name="l00444"></a>00444         std::cout&lt;&lt;rank&lt;&lt;<span class="stringliteral">": receive for process "</span>&lt;&lt;infoPair-&gt;first&lt;&lt;<span class="stringliteral">": "</span>;
<a name="l00445"></a>00445         <span class="keyword">const</span> <a class="code" href="a00062.html" title="Information describing an interface.">InterfaceInformation</a>&amp; info(infoPair-&gt;second.second);
<a name="l00446"></a>00446         <span class="keywordflow">for</span>(<span class="keywordtype">size_t</span> i=0; i &lt; info.<a class="code" href="a00062.html#e8863c2780ec2be39bf0fe7577beff6f" title="Get the number of entries in the interface.">size</a>(); i++)
<a name="l00447"></a>00447           std::cout&lt;&lt;info[i]&lt;&lt;<span class="stringliteral">" "</span>;
<a name="l00448"></a>00448         std::cout&lt;&lt;std::endl;
<a name="l00449"></a>00449       }
<a name="l00450"></a>00450       
<a name="l00451"></a>00451     }
<a name="l00452"></a>00452   }
<a name="l00453"></a>00453   
<a name="l00454"></a>00454   <span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;
<a name="l00455"></a>00455   <span class="keyword">template</span>&lt;<span class="keyword">typename</span> T1, <span class="keyword">typename</span> T2&gt;
<a name="l00456"></a><a class="code" href="a00195.html#g5d3351c8857ba5cfdd74d28bb5725a30">00456</a>   <span class="keywordtype">void</span> <a class="code" href="a00060.html" title="Communication interface between remote and local indices.">Interface&lt;T&gt;::build</a>(<span class="keyword">const</span> <a class="code" href="a00097.html" title="The indices present on remote processes.">RemoteIndices</a>&amp; remoteIndices, <span class="keyword">const</span> T1&amp; sourceFlags, 
<a name="l00457"></a>00457                           <span class="keyword">const</span> T2&amp; destFlags)
<a name="l00458"></a>00458   {
<a name="l00459"></a>00459     remoteIndices_=&amp;remoteIndices;
<a name="l00460"></a>00460     
<a name="l00461"></a>00461     assert(interfaces_.empty());
<a name="l00462"></a>00462 
<a name="l00463"></a>00463     <span class="comment">// Build the send interface</span>
<a name="l00464"></a>00464     InformationBuilder&lt;true&gt; sendInformation(interfaces_);
<a name="l00465"></a>00465     this-&gt;<span class="keyword">template</span> buildInterface&lt;T1,T2,InformationBuilder&lt;true&gt;,<span class="keyword">true</span>&gt;(remoteIndices, sourceFlags, 
<a name="l00466"></a>00466                                                               destFlags, sendInformation);
<a name="l00467"></a>00467     
<a name="l00468"></a>00468     <span class="comment">// Build the receive interface</span>
<a name="l00469"></a>00469     InformationBuilder&lt;false&gt; recvInformation(interfaces_);
<a name="l00470"></a>00470     this-&gt;<span class="keyword">template</span> buildInterface&lt;T1,T2,InformationBuilder&lt;false&gt;,<span class="keyword">false</span>&gt;(remoteIndices,sourceFlags, 
<a name="l00471"></a>00471                                                                 destFlags, recvInformation);
<a name="l00472"></a>00472     
<a name="l00473"></a>00473   }
<a name="l00474"></a>00474   
<a name="l00475"></a>00475   <span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;
<a name="l00476"></a><a class="code" href="a00195.html#g7998a5cc771852a49c8833b52e82a0ba">00476</a>   <span class="keywordtype">void</span> <a class="code" href="a00060.html" title="Communication interface between remote and local indices.">Interface&lt;T&gt;::free</a>()
<a name="l00477"></a>00477   {
<a name="l00478"></a>00478     <span class="keyword">typedef</span> InformationMap::iterator iterator;
<a name="l00479"></a>00479     <span class="keyword">typedef</span> InformationMap::const_iterator const_iterator;
<a name="l00480"></a>00480     <span class="keyword">const</span> const_iterator end = interfaces_.end();
<a name="l00481"></a>00481     <span class="keywordflow">for</span>(iterator interfacePair = interfaces_.begin(); interfacePair != end; ++interfacePair){
<a name="l00482"></a>00482       interfacePair-&gt;second.first.free();
<a name="l00483"></a>00483       interfacePair-&gt;second.second.free();
<a name="l00484"></a>00484     }
<a name="l00485"></a>00485     interfaces_.clear();
<a name="l00486"></a>00486   }
<a name="l00487"></a>00487   <span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;
<a name="l00488"></a><a class="code" href="a00195.html#gb19c7dee343bf007f23da5eb62d97436">00488</a>   <a class="code" href="a00060.html" title="Communication interface between remote and local indices.">Interface&lt;T&gt;::~Interface</a>()
<a name="l00489"></a>00489   {
<a name="l00490"></a>00490     <a class="code" href="a00195.html#g7998a5cc771852a49c8833b52e82a0ba" title="Frees memory allocated during the build.">free</a>();
<a name="l00491"></a>00491   }
<a name="l00493"></a>00493 }
<a name="l00494"></a>00494 
<a name="l00495"></a>00495 <span class="preprocessor">#endif</span>
</pre></div></div>
</div> <!-- end doxygen -->
</div> <!-- end main -->
<div class="foot">

<p class="foot">
  Generated on 6 Nov 2008 with <a
  href="http://www.doxygen.org/">Doxygen</a> (ver 1.5.6)  
  [<a href="doxygen.log">logfile</a>].
</p>

</div>

</body>
</html>
